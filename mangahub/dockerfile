# =========================
# BUILD STAGE
# =========================
FROM golang:1.25-alpine AS builder

RUN apk add --no-cache git ca-certificates gcc musl-dev sqlite-dev

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .

# Build ONLY what we actually run
RUN CGO_ENABLED=1 GOOS=linux GOARCH=amd64 \
    go build -o /app/api-server ./cmd/api-server

RUN CGO_ENABLED=1 GOOS=linux GOARCH=amd64 \
    go build -o /app/tcp-server ./cmd/tcp-server

# =========================
# API RUNTIME
# =========================
FROM alpine:3.20 AS api-runtime

RUN apk add --no-cache ca-certificates sqlite-libs

WORKDIR /app

COPY --from=builder /app/api-server .
COPY --from=builder /app/tcp-server .

# Persistent DB directory
RUN mkdir -p /data

EXPOSE 8080 50051 9091

HEALTHCHECK --interval=30s --timeout=3s \
  CMD wget -q -O- http://localhost:8080/health || exit 1

CMD ["./api-server"]

# =========================
# TCP SYNC RUNTIME
# =========================
FROM alpine:3.20 AS tcp-runtime

RUN apk add --no-cache ca-certificates

WORKDIR /app
COPY --from=builder /app/tcp-server .

EXPOSE 9090

CMD ["./tcp-server"]
